#!/bin/bash
# swivel — Session Context Protocol CLI
# Version: 0.2.0
# Owner: Omega
# Usage: swivel [command] [options]

set -e

SWIVEL_VERSION="0.2.0"
WORKSPACE_ROOT="${SWIVEL_ROOT:-../workspace}"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

usage() {
    cat << EOF
swivel — Session Context Protocol v$SWIVEL_VERSION

Commands:
  status [topic|path]     Show swivel status and drift
  verify [topic|path]     Run healthcheck, update drift
  drift [--since=hours]   List all swivels with drift
  archive [topic]         Move to archived status
  fleet-health            Check all fleet agent swivels
  init [topic]            Create new swivel from template

Options:
  --workspace=PATH        Set workspace root (default: ../workspace)
  --json                  Output as JSON
  --severity=level        Filter by drift severity (info|warn|error|critical)

Examples:
  swivel status oakmont-ab-test
  swivel verify ../workspace-alpha/.swivel.md
  swivel drift --since=24 --severity=error
  swivel fleet-health --json
EOF
}

# Parse YAML frontmatter (simple grep-based parser for now)
parse_swivel() {
    local file="$1"
    if [[ ! -f "$file" ]]; then
        echo "Error: Swivel file not found: $file" >&2
        return 1
    fi
    
    # Extract YAML frontmatter between --- markers
    awk '/^---$/{if(seen){exit}seen=1;next} seen{print}' "$file" | head -50
}

# Get a value from parsed YAML
get_yaml_value() {
    local yaml="$1"
    local key="$2"
    echo "$yaml" | grep "^${key}:" | head -1 | cut -d':' -f2- | sed 's/^ *//'
}

# Check if swivel has expired TTL
check_ttl() {
    local file="$1"
    local yaml=$(parse_swivel "$file")
    
    local ttl=$(get_yaml_value "$yaml" "ttl_hours")
    local verified=$(get_yaml_value "$yaml" "last_verified")
    
    if [[ -z "$ttl" || -z "$verified" ]]; then
        echo "unknown"
        return
    fi
    
    # Convert to epoch seconds (macOS compatible)
    local verified_epoch=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$verified" +%s 2>/dev/null || date -d "$verified" +%s 2>/dev/null)
    local now_epoch=$(date +%s)
    local age_hours=$(( (now_epoch - verified_epoch) / 3600 ))
    
    if [[ $age_hours -gt $ttl ]]; then
        echo "expired:$age_hours:$ttl"
    else
        echo "valid:$age_hours:$ttl"
    fi
}

# Run healthcheck if defined
run_healthcheck() {
    local file="$1"
    local yaml=$(parse_swivel "$file")
    
    local hc_type=$(echo "$yaml" | grep -A10 "^healthcheck:" | grep "type:" | head -1 | cut -d':' -f2 | tr -d ' ')
    local hc_cmd=$(echo "$yaml" | grep -A10 "^healthcheck:" | grep "command:" | head -1 | cut -d':' -f2- | sed 's/^ *//')
    local hc_expected=$(echo "$yaml" | grep -A10 "^healthcheck:" | grep "expected:" | head -1 | cut -d':' -f2 | tr -d ' ')
    
    if [[ -z "$hc_type" || "$hc_type" == "null" ]]; then
        echo "none"
        return
    fi
    
    if [[ "$hc_type" == "command" && -n "$hc_cmd" ]]; then
        local result
        if result=$(eval "$hc_cmd" 2>/dev/null); then
            # Check result against expected
            if [[ "$hc_expected" == ">0" && -n "$result" ]]; then
                echo "pass:$result"
            elif [[ "$hc_expected" == "$result" ]]; then
                echo "pass:$result"
            else
                echo "fail:expected '$hc_expected', got '$result'"
            fi
        else
            echo "fail:command returned non-zero"
        fi
    else
        echo "unsupported:type '$hc_type'"
    fi
}

# Detect drift based on healthcheck and TTL
detect_drift() {
    local file="$1"
    local yaml=$(parse_swivel "$file")
    
    local mode=$(get_yaml_value "$yaml" "mode")
    local status_drift="none"
    local severity="info"
    local details=""
    
    # Check TTL
    local ttl_status=$(check_ttl "$file")
    if [[ "$ttl_status" == expired:* ]]; then
        status_drift="ttl_expired"
        severity="warn"
        details="Swivel expired: ${ttl_status#expired:}"
    fi
    
    # Check healthcheck
    local hc_result=$(run_healthcheck "$file")
    if [[ "$hc_result" != "none" && "$hc_result" != pass:* ]]; then
        if [[ "$mode" == "active" || "$mode" == "running" ]]; then
            status_drift="process_mismatch"
            severity="error"
            details="Healthcheck failed: ${hc_result#fail:}"
        fi
    fi
    
    # Check for topic orphan (no activity for 7+ days)
    local updated=$(get_yaml_value "$yaml" "updated")
    if [[ -n "$updated" ]]; then
        local updated_epoch=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$updated" +%s 2>/dev/null || date -d "$updated" +%s 2>/dev/null)
        local now_epoch=$(date +%s)
        local age_days=$(( (now_epoch - updated_epoch) / 86400 ))
        
        if [[ $age_days -gt 7 && "$mode" == "active" ]]; then
            status_drift="topic_orphan"
            severity="warn"
            details="No activity for $age_days days"
        fi
    fi
    
    echo "$status_drift|$severity|$details"
}

# Update drift section in swivel file
update_swivel_drift() {
    local file="$1"
    local drift_status="$2"
    local severity="$3"
    local details="$4"
    
    local now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    # This is a simple sed replacement - in production, use a proper YAML editor
    # For now, we just report what would be updated
    echo "Would update $file:"
    echo "  drift.status: $drift_status"
    echo "  drift.severity: $severity"
    echo "  drift.detected_at: $now"
    echo "  last_verified: $now"
    echo "  verified_by: omega"
}

# Command: status
cmd_status() {
    local target="${1:-.}"
    local file=""
    
    # Resolve target to file path
    if [[ -f "$target" ]]; then
        file="$target"
    elif [[ -f "$WORKSPACE_ROOT/.swivel.md" && -z "$target" ]]; then
        file="$WORKSPACE_ROOT/.swivel.md"
    elif [[ -f "$WORKSPACE_ROOT/$target.swivel.md" ]]; then
        file="$WORKSPACE_ROOT/$target.swivel.md"
    elif [[ -f "$WORKSPACE_ROOT/$target/.swivel.md" ]]; then
        file="$WORKSPACE_ROOT/$target/.swivel.md"
    else
        echo "Error: Cannot find swivel for '$target'" >&2
        return 1
    fi
    
    local yaml=$(parse_swivel "$file")
    local id=$(get_yaml_value "$yaml" "swivel_id")
    local mode=$(get_yaml_value "$yaml" "mode")
    local updated=$(get_yaml_value "$yaml" "updated")
    local verified=$(get_yaml_value "$yaml" "last_verified")
    local ttl=$(get_yaml_value "$yaml" "ttl_hours")
    
    echo "Swivel: $id"
    echo "File: $file"
    echo "Mode: $mode"
    echo "Updated: $updated"
    echo "TTL: ${ttl:-none} hours"
    echo "Last Verified: ${verified:-never}"
    
    # Check TTL
    local ttl_status=$(check_ttl "$file")
    if [[ "$ttl_status" == expired:* ]]; then
        echo -e "${YELLOW}⚠️ TTL Status: EXPIRED (${ttl_status#expired:}h old)${NC}"
    elif [[ "$ttl_status" == valid:* ]]; then
        local age=$(echo "$ttl_status" | cut -d':' -f2)
        echo -e "${GREEN}✓ TTL Status: Valid (${age}h old)${NC}"
    fi
    
    # Check drift
    local drift=$(detect_drift "$file")
    local drift_status=$(echo "$drift" | cut -d'|' -f1)
    local drift_sev=$(echo "$drift" | cut -d'|' -f2)
    local drift_details=$(echo "$drift" | cut -d'|' -f3)
    
    if [[ "$drift_status" != "none" ]]; then
        if [[ "$drift_sev" == "error" || "$drift_sev" == "critical" ]]; then
            echo -e "${RED}✗ Drift: $drift_status${NC}"
        else
            echo -e "${YELLOW}⚠ Drift: $drift_status${NC}"
        fi
        [[ -n "$drift_details" ]] && echo "  Details: $drift_details"
    else
        echo -e "${GREEN}✓ Drift: None${NC}"
    fi
}

# Command: verify
cmd_verify() {
    local target="${1:-.}"
    local file=""
    
    # Resolve target to file path
    if [[ -f "$target" ]]; then
        file="$target"
    elif [[ -f "$WORKSPACE_ROOT/$target.swivel.md" ]]; then
        file="$WORKSPACE_ROOT/$target.swivel.md"
    elif [[ -f "$WORKSPACE_ROOT/$target/.swivel.md" ]]; then
        file="$WORKSPACE_ROOT/$target/.swivel.md"
    else
        echo "Error: Cannot find swivel for '$target'" >&2
        return 1
    fi
    
    echo "Verifying: $file"
    echo ""
    
    # Run healthcheck
    local hc_result=$(run_healthcheck "$file")
    echo "Healthcheck: $hc_result"
    
    # Detect drift
    local drift=$(detect_drift "$file")
    local drift_status=$(echo "$drift" | cut -d'|' -f1)
    local drift_sev=$(echo "$drift" | cut -d'|' -f2)
    local drift_details=$(echo "$drift" | cut -d'|' -f3)
    
    echo ""
    if [[ "$drift_status" == "none" ]]; then
        echo -e "${GREEN}✓ Verification passed. No drift detected.${NC}"
    else
        echo -e "${RED}✗ Drift detected: $drift_status (${drift_sev})${NC}"
        [[ -n "$drift_details" ]] && echo "  $drift_details"
        echo ""
        update_swivel_drift "$file" "$drift_status" "$drift_sev" "$drift_details"
    fi
}

# Command: drift
cmd_drift() {
    local since_hours=24
    local min_severity="info"
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --since=*)
                since_hours="${1#*=}"
                shift
                ;;
            --severity=*)
                min_severity="${1#*=}"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo "Checking for drift (since ${since_hours}h, severity >= $min_severity)..."
    echo ""
    
    # Find all swivel files
    local found=0
    while IFS= read -r file; do
        local drift=$(detect_drift "$file")
        local drift_status=$(echo "$drift" | cut -d'|' -f1)
        local drift_sev=$(echo "$drift" | cut -d'|' -f2)
        
        if [[ "$drift_status" != "none" ]]; then
            local yaml=$(parse_swivel "$file")
            local id=$(get_yaml_value "$yaml" "swivel_id")
            
            if [[ "$drift_sev" == "error" || "$drift_sev" == "critical" ]]; then
                echo -e "${RED}✗ $id: $drift_status ($drift_sev)${NC} — $file"
            else
                echo -e "${YELLOW}⚠ $id: $drift_status ($drift_sev)${NC} — $file"
            fi
            found=$((found + 1))
        fi
    done < <(find "$WORKSPACE_ROOT" -name "*.swivel.md" -type f 2>/dev/null)
    
    echo ""
    if [[ $found -eq 0 ]]; then
        echo -e "${GREEN}✓ No drift detected in $WORKSPACE_ROOT${NC}"
    else
        echo "$found swivel(s) with drift detected"
    fi
}

# Command: fleet-health
cmd_fleet_health() {
    local json_output=false
    
    if [[ "$1" == "--json" ]]; then
        json_output=true
    fi
    
    local agents=("$WORKSPACE_ROOT/../workspace" "$WORKSPACE_ROOT/../workspace-forge" "$WORKSPACE_ROOT/../workspace-alpha" "$WORKSPACE_ROOT/../workspace-omega")
    local agent_names=("swiv" "forge" "alpha" "omega")
    
    if [[ "$json_output" == true ]]; then
        echo "{"
        echo '  "fleet_health": {'
        echo '    "agents": ['
    else
        echo "=== Fleet Health ==="
        echo ""
    fi
    
    local first=true
    for i in "${!agents[@]}"; do
        local agent_dir="${agents[$i]}"
        local agent_name="${agent_names[$i]}"
        local swivel_file="$agent_dir/.swivel.md"
        
        if [[ ! -f "$swivel_file" ]]; then
            if [[ "$json_output" == true ]]; then
                [[ "$first" == false ]] && echo ","
                echo "      {"
                echo "        \"name\": \"$agent_name\","
                echo "        \"status\": \"no_swivel\","
                echo "        \"drift\": \"missing\""
                echo -n "      }"
                first=false
            else
                echo -e "${RED}✗ $agent_name: NO SWIVEL FILE${NC}"
            fi
            continue
        fi
        
        local yaml=$(parse_swivel "$swivel_file")
        local mode=$(get_yaml_value "$yaml" "mode")
        local updated=$(get_yaml_value "$yaml" "updated")
        local drift=$(detect_drift "$swivel_file")
        local drift_status=$(echo "$drift" | cut -d'|' -f1)
        
        if [[ "$json_output" == true ]]; then
            [[ "$first" == false ]] && echo ","
            echo "      {"
            echo "        \"name\": \"$agent_name\","
            echo "        \"status\": \"$mode\","
            echo "        \"updated\": \"$updated\","
            echo "        \"drift\": \"$drift_status\""
            echo -n "      }"
            first=false
        else
            if [[ "$drift_status" != "none" ]]; then
                echo -e "${RED}✗ $agent_name: $mode (drift: $drift_status)${NC}"
            else
                local ttl_check=$(check_ttl "$swivel_file")
                if [[ "$ttl_check" == expired:* ]]; then
                    echo -e "${YELLOW}⚠ $agent_name: $mode (TTL expired)${NC}"
                else
                    echo -e "${GREEN}✓ $agent_name: $mode${NC}"
                fi
            fi
            echo "  Swivel: $updated"
            echo ""
        fi
    done
    
    if [[ "$json_output" == true ]]; then
        echo ""
        echo '    ]'
        echo '  }'
        echo "}"
    fi
}

# Command: archive
cmd_archive() {
    local target="$1"
    
    if [[ -z "$target" ]]; then
        echo "Error: Specify topic to archive" >&2
        return 1
    fi
    
    local file=""
    if [[ -f "$WORKSPACE_ROOT/$target.swivel.md" ]]; then
        file="$WORKSPACE_ROOT/$target.swivel.md"
    elif [[ -f "$WORKSPACE_ROOT/$target/.swivel.md" ]]; then
        file="$WORKSPACE_ROOT/$target/.swivel.md"
    else
        echo "Error: Cannot find swivel for '$target'" >&2
        return 1
    fi
    
    echo "Archiving: $file"
    # In production, this would update the YAML frontmatter
    # For now, just report what would happen
    echo "  mode: archived"
    echo "  archived_at: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
    echo "  (Use sed or yq to actually update the file)"
}

# Command: init
cmd_init() {
    local topic="$1"
    
    if [[ -z "$topic" ]]; then
        echo "Error: Specify topic name" >&2
        return 1
    fi
    
    local file="$WORKSPACE_ROOT/$topic.swivel.md"
    
    if [[ -f "$file" ]]; then
        echo "Error: Swivel already exists: $file" >&2
        return 1
    fi
    
    local now=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    cat > "$file" << EOF
---
swivel_version: 0.2.0
swivel_id: $topic
swivel_type: topic
session_id: null
created: $now
updated: $now
updated_by: omega
mode: active
ttl_hours: 24
last_verified: $now
verified_by: omega
drift:
  status: none
healthcheck:
  type: null
---

## Load
- ./$topic.swivel.md
- ../SOUL.md
- ../USER.md

## State
- **status**: initializing

## Files

## Continuity
**Created**: $now

## Blockers
- None

## Decisions
EOF

    echo "Created: $file"
}

# Main dispatcher
case "${1:-}" in
    status) shift; cmd_status "$@" ;;
    verify) shift; cmd_verify "$@" ;;
    drift) shift; cmd_drift "$@" ;;
    archive) shift; cmd_archive "$@" ;;
    fleet-health) shift; cmd_fleet_health "$@" ;;
    init) shift; cmd_init "$@" ;;
    --version|-v) echo "swivel v$SWIVEL_VERSION" ;;
    --help|-h|*) usage ;;
esac
